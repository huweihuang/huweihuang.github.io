<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content>
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          kube-apiserver源码分析（一）之 NewAPIServerCommand - 胡伟煌 | Blog
        
    </title>

    <link rel="canonical" href="http://www.huweihuang.com/article/k8s-source-code-analysis/kube-apiserver/NewAPIServerCommand/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">

    <link rel="stylesheet" href="/css/donate.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('https://res.cloudinary.com/dqxtn0ick/image/upload/v1542285471/header/building.jpg')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#源码分析" title="源码分析">源码分析</a>
                            
                        </div>
                        <h1>kube-apiserver源码分析（一）之 NewAPIServerCommand</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by 胡伟煌 on
                            2018-10-03
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">胡伟煌</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1 id="kube-apiserver源码分析一之-newapiservercommand">kube-apiserver源码分析（一）之 NewAPIServerCommand</h1>
<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析<code>kube-apiserver</code>中<code>cmd</code>部分的代码，即<code>NewAPIServerCommand</code>相关的代码。更多具体的逻辑待后续文章分析。</p>
<p><code>kube-apiserver</code>的<code>cmd</code>部分目录代码结构如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kube-apiserver</span><br><span class="line">├── apiserver.go   <span class="comment"># kube-apiserver的main入口</span></span><br><span class="line">└── app</span><br><span class="line">    ├── aggregator.go</span><br><span class="line">    ├── apiextensions.go</span><br><span class="line">    ├── options  <span class="comment"># 初始化kube-apiserver使用到的option</span></span><br><span class="line">    │   ├── options.go     <span class="comment"># 包括：NewServerRunOptions、Flags等</span></span><br><span class="line">    │   ├── options_test.go</span><br><span class="line">    │   └── validation.go</span><br><span class="line">    ├── server.go   <span class="comment"># 包括：NewAPIServerCommand、Run、CreateServerChain、Complete等</span></span><br></pre></td></tr></table></figure>
<h1 id="1-main">1. Main</h1>
<blockquote>
<p>此部分代码位于cmd/kube-apiserver/apiserver.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	rand.Seed(time.Now().UTC().UnixNano())</span><br><span class="line"></span><br><span class="line">	command := app.NewAPIServerCommand(server.SetupSignalHandler())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> once we switch everything over to Cobra commands, we can go back to calling</span></span><br><span class="line">	<span class="comment">// utilflag.InitFlags() (by removing its pflag.Parse() call). For now, we have to set the</span></span><br><span class="line">	<span class="comment">// normalize func and add the go flag set by hand.</span></span><br><span class="line">	pflag.CommandLine.SetNormalizeFunc(utilflag.WordSepNormalizeFunc)</span><br><span class="line">	pflag.CommandLine.AddGoFlagSet(goflag.CommandLine)</span><br><span class="line">	<span class="comment">// utilflag.InitFlags()</span></span><br><span class="line">	logs.InitLogs()</span><br><span class="line">	<span class="keyword">defer</span> logs.FlushLogs()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := command.Execute(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Fprintf(os.Stderr, <span class="string">"error: %v\n"</span>, err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化APIServerCommand</span></span><br><span class="line">command := app.NewAPIServerCommand(server.SetupSignalHandler())</span><br><span class="line"><span class="comment">// 执行Execute</span></span><br><span class="line">err := command.Execute()</span><br></pre></td></tr></table></figure>
<h1 id="2-newapiservercommand">2. NewAPIServerCommand</h1>
<blockquote>
<p>此部分的代码位于/cmd/kube-apiserver/app/server.go</p>
</blockquote>
<p><code>NewAPIServerCommand</code>即<a href="https://github.com/spf13/cobra" target="_blank" rel="noopener">Cobra</a>命令行框架的构造函数，主要包括三部分：</p>
<ul>
<li>构造option</li>
<li>添加Flags</li>
<li>执行Run函数</li>
</ul>
<p>完整代码如下：</p>
<blockquote>
<p>此部分代码位于cmd/kube-apiserver/app/server.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewAPIServerCommand creates a *cobra.Command object with default parameters</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAPIServerCommand</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> *<span class="title">cobra</span>.<span class="title">Command</span></span> &#123;</span><br><span class="line">	s := options.NewServerRunOptions()</span><br><span class="line">	cmd := &amp;cobra.Command&#123;</span><br><span class="line">		Use: <span class="string">"kube-apiserver"</span>,</span><br><span class="line">		Long: <span class="string">`The Kubernetes API server validates and configures data</span></span><br><span class="line"><span class="string">for the api objects which include pods, services, replicationcontrollers, and</span></span><br><span class="line"><span class="string">others. The API Server services REST operations and provides the frontend to the</span></span><br><span class="line"><span class="string">cluster's shared state through which all other components interact.`</span>,</span><br><span class="line">		RunE: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">			verflag.PrintAndExitIfRequested()</span><br><span class="line">			utilflag.PrintFlags(cmd.Flags())</span><br><span class="line"></span><br><span class="line">			<span class="comment">// set default options</span></span><br><span class="line">			completedOptions, err := Complete(s)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// validate options</span></span><br><span class="line">			<span class="keyword">if</span> errs := completedOptions.Validate(); <span class="built_in">len</span>(errs) != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> utilerrors.NewAggregate(errs)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> Run(completedOptions, stopCh)</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fs := cmd.Flags()</span><br><span class="line">	namedFlagSets := s.Flags()</span><br><span class="line">	<span class="keyword">for</span> _, f := <span class="keyword">range</span> namedFlagSets.FlagSets &#123;</span><br><span class="line">		fs.AddFlagSet(f)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	usageFmt := <span class="string">"Usage:\n  %s\n"</span></span><br><span class="line">	cols, _, _ := apiserverflag.TerminalSize(cmd.OutOrStdout())</span><br><span class="line">	cmd.SetUsageFunc(<span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		fmt.Fprintf(cmd.OutOrStderr(), usageFmt, cmd.UseLine())</span><br><span class="line">		apiserverflag.PrintSections(cmd.OutOrStderr(), namedFlagSets, cols)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	cmd.SetHelpFunc(<span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">		fmt.Fprintf(cmd.OutOrStdout(), <span class="string">"%s\n\n"</span>+usageFmt, cmd.Long, cmd.UseLine())</span><br><span class="line">		apiserverflag.PrintSections(cmd.OutOrStdout(), namedFlagSets, cols)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> cmd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造option</span></span><br><span class="line">s := options.NewServerRunOptions()</span><br><span class="line"><span class="comment">// 添加flags</span></span><br><span class="line">fs := cmd.Flags()</span><br><span class="line">namedFlagSets := s.Flags()</span><br><span class="line"><span class="keyword">for</span> _, f := <span class="keyword">range</span> namedFlagSets.FlagSets &#123;</span><br><span class="line">	fs.AddFlagSet(f)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// set default options</span></span><br><span class="line">completedOptions, err := Complete(s)</span><br><span class="line"><span class="comment">// Run</span></span><br><span class="line">Run(completedOptions, stopCh)</span><br></pre></td></tr></table></figure>
<h1 id="3-newserverrunoptions">3. NewServerRunOptions</h1>
<p><code>NewServerRunOptions</code>基于默认的参数构造<code>ServerRunOptions</code>结构体。<code>ServerRunOptions</code>是apiserver运行的配置信息。具体结构体定义如下。</p>
<h2 id="31-serverrunoptions">3.1. ServerRunOptions</h2>
<p>其中主要的配置如下：</p>
<ul>
<li>GenericServerRunOptions</li>
<li>Etcd</li>
<li>SecureServing</li>
<li>KubeletConfig</li>
<li>…</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServerRunOptions runs a kubernetes api server.</span></span><br><span class="line"><span class="keyword">type</span> ServerRunOptions <span class="keyword">struct</span> &#123;</span><br><span class="line">	GenericServerRunOptions *genericoptions.ServerRunOptions</span><br><span class="line">	Etcd                    *genericoptions.EtcdOptions</span><br><span class="line">	SecureServing           *genericoptions.SecureServingOptionsWithLoopback</span><br><span class="line">	InsecureServing         *genericoptions.DeprecatedInsecureServingOptionsWithLoopback</span><br><span class="line">	Audit                   *genericoptions.AuditOptions</span><br><span class="line">	Features                *genericoptions.FeatureOptions</span><br><span class="line">	Admission               *kubeoptions.AdmissionOptions</span><br><span class="line">	Authentication          *kubeoptions.BuiltInAuthenticationOptions</span><br><span class="line">	Authorization           *kubeoptions.BuiltInAuthorizationOptions</span><br><span class="line">	CloudProvider           *kubeoptions.CloudProviderOptions</span><br><span class="line">	StorageSerialization    *kubeoptions.StorageSerializationOptions</span><br><span class="line">	APIEnablement           *genericoptions.APIEnablementOptions</span><br><span class="line"></span><br><span class="line">	AllowPrivileged           <span class="keyword">bool</span></span><br><span class="line">	EnableLogsHandler         <span class="keyword">bool</span></span><br><span class="line">	EventTTL                  time.Duration</span><br><span class="line">	KubeletConfig             kubeletclient.KubeletClientConfig</span><br><span class="line">	KubernetesServiceNodePort <span class="keyword">int</span></span><br><span class="line">	MaxConnectionBytesPerSec  <span class="keyword">int64</span></span><br><span class="line">	ServiceClusterIPRange     net.IPNet <span class="comment">// <span class="doctag">TODO:</span> make this a list</span></span><br><span class="line">	ServiceNodePortRange      utilnet.PortRange</span><br><span class="line">	SSHKeyfile                <span class="keyword">string</span></span><br><span class="line">	SSHUser                   <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	ProxyClientCertFile <span class="keyword">string</span></span><br><span class="line">	ProxyClientKeyFile  <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	EnableAggregatorRouting <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	MasterCount            <span class="keyword">int</span></span><br><span class="line">	EndpointReconcilerType <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	ServiceAccountSigningKeyFile <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="32-newserverrunoptions">3.2. NewServerRunOptions</h2>
<p><code>NewServerRunOptions</code>初始化配置结构体。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewServerRunOptions creates a new ServerRunOptions object with default parameters</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewServerRunOptions</span><span class="params">()</span> *<span class="title">ServerRunOptions</span></span> &#123;</span><br><span class="line">	s := ServerRunOptions&#123;</span><br><span class="line">		GenericServerRunOptions: genericoptions.NewServerRunOptions(),</span><br><span class="line">		Etcd:                 genericoptions.NewEtcdOptions(storagebackend.NewDefaultConfig(kubeoptions.DefaultEtcdPathPrefix, <span class="literal">nil</span>)),</span><br><span class="line">		SecureServing:        kubeoptions.NewSecureServingOptions(),</span><br><span class="line">		InsecureServing:      kubeoptions.NewInsecureServingOptions(),</span><br><span class="line">		Audit:                genericoptions.NewAuditOptions(),</span><br><span class="line">		Features:             genericoptions.NewFeatureOptions(),</span><br><span class="line">		Admission:            kubeoptions.NewAdmissionOptions(),</span><br><span class="line">		Authentication:       kubeoptions.NewBuiltInAuthenticationOptions().WithAll(),</span><br><span class="line">		Authorization:        kubeoptions.NewBuiltInAuthorizationOptions(),</span><br><span class="line">		CloudProvider:        kubeoptions.NewCloudProviderOptions(),</span><br><span class="line">		StorageSerialization: kubeoptions.NewStorageSerializationOptions(),</span><br><span class="line">		APIEnablement:        genericoptions.NewAPIEnablementOptions(),</span><br><span class="line"></span><br><span class="line">		EnableLogsHandler:      <span class="literal">true</span>,</span><br><span class="line">		EventTTL:               <span class="number">1</span> * time.Hour,</span><br><span class="line">		MasterCount:            <span class="number">1</span>,</span><br><span class="line">		EndpointReconcilerType: <span class="keyword">string</span>(reconcilers.LeaseEndpointReconcilerType),</span><br><span class="line">		KubeletConfig: kubeletclient.KubeletClientConfig&#123;</span><br><span class="line">			Port:         ports.KubeletPort,</span><br><span class="line">			ReadOnlyPort: ports.KubeletReadOnlyPort,</span><br><span class="line">			PreferredAddressTypes: []<span class="keyword">string</span>&#123;</span><br><span class="line">				<span class="comment">// --override-hostname</span></span><br><span class="line">				<span class="keyword">string</span>(api.NodeHostName),</span><br><span class="line"></span><br><span class="line">				<span class="comment">// internal, preferring DNS if reported</span></span><br><span class="line">				<span class="keyword">string</span>(api.NodeInternalDNS),</span><br><span class="line">				<span class="keyword">string</span>(api.NodeInternalIP),</span><br><span class="line"></span><br><span class="line">				<span class="comment">// external, preferring DNS if reported</span></span><br><span class="line">				<span class="keyword">string</span>(api.NodeExternalDNS),</span><br><span class="line">				<span class="keyword">string</span>(api.NodeExternalIP),</span><br><span class="line">			&#125;,</span><br><span class="line">			EnableHttps: <span class="literal">true</span>,</span><br><span class="line">			HTTPTimeout: time.Duration(<span class="number">5</span>) * time.Second,</span><br><span class="line">		&#125;,</span><br><span class="line">		ServiceNodePortRange: kubeoptions.DefaultServiceNodePortRange,</span><br><span class="line">	&#125;</span><br><span class="line">	s.ServiceClusterIPRange = kubeoptions.DefaultServiceIPCIDR</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Overwrite the default for storage data format.</span></span><br><span class="line">	s.Etcd.DefaultStorageMediaType = <span class="string">"application/vnd.kubernetes.protobuf"</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="33-complete">3.3. Complete</h2>
<p>当kube-apiserver的flags被解析后，调用<code>Complete</code>完成默认配置。</p>
<blockquote>
<p>此部分代码位于cmd/kube-apiserver/app/server.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Should be called after kube-apiserver flags parsed.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Complete</span><span class="params">(s *options.ServerRunOptions)</span> <span class="params">(completedServerRunOptions, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> options completedServerRunOptions</span><br><span class="line">	<span class="comment">// set defaults</span></span><br><span class="line">	<span class="keyword">if</span> err := s.GenericServerRunOptions.DefaultAdvertiseAddress(s.SecureServing.SecureServingOptions); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> options, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := kubeoptions.DefaultAdvertiseAddress(s.GenericServerRunOptions, s.InsecureServing.DeprecatedInsecureServingOptions); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> options, err</span><br><span class="line">	&#125;</span><br><span class="line">	serviceIPRange, apiServerServiceIP, err := master.DefaultServiceIPRange(s.ServiceClusterIPRange)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> options, fmt.Errorf(<span class="string">"error determining service IP ranges: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	s.ServiceClusterIPRange = serviceIPRange</span><br><span class="line">	<span class="keyword">if</span> err := s.SecureServing.MaybeDefaultWithSelfSignedCerts(s.GenericServerRunOptions.AdvertiseAddress.String(), []<span class="keyword">string</span>&#123;<span class="string">"kubernetes.default.svc"</span>, <span class="string">"kubernetes.default"</span>, <span class="string">"kubernetes"</span>&#125;, []net.IP&#123;apiServerServiceIP&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> options, fmt.Errorf(<span class="string">"error creating self-signed certificates: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s.GenericServerRunOptions.ExternalHost) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(s.GenericServerRunOptions.AdvertiseAddress) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			s.GenericServerRunOptions.ExternalHost = s.GenericServerRunOptions.AdvertiseAddress.String()</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> hostname, err := os.Hostname(); err == <span class="literal">nil</span> &#123;</span><br><span class="line">				s.GenericServerRunOptions.ExternalHost = hostname</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> options, fmt.Errorf(<span class="string">"error finding host name: %v"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		glog.Infof(<span class="string">"external host was not specified, using %v"</span>, s.GenericServerRunOptions.ExternalHost)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	s.Authentication.ApplyAuthorization(s.Authorization)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use (ServiceAccountSigningKeyFile != "") as a proxy to the user enabling</span></span><br><span class="line">	<span class="comment">// TokenRequest functionality. This defaulting was convenient, but messed up</span></span><br><span class="line">	<span class="comment">// a lot of people when they rotated their serving cert with no idea it was</span></span><br><span class="line">	<span class="comment">// connected to their service account keys. We are taking this oppurtunity to</span></span><br><span class="line">	<span class="comment">// remove this problematic defaulting.</span></span><br><span class="line">	<span class="keyword">if</span> s.ServiceAccountSigningKeyFile == <span class="string">""</span> &#123;</span><br><span class="line">		<span class="comment">// Default to the private server key for service account token signing</span></span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(s.Authentication.ServiceAccounts.KeyFiles) == <span class="number">0</span> &amp;&amp; s.SecureServing.ServerCert.CertKey.KeyFile != <span class="string">""</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> kubeauthenticator.IsValidServiceAccountKeyFile(s.SecureServing.ServerCert.CertKey.KeyFile) &#123;</span><br><span class="line">				s.Authentication.ServiceAccounts.KeyFiles = []<span class="keyword">string</span>&#123;s.SecureServing.ServerCert.CertKey.KeyFile&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				glog.Warning(<span class="string">"No TLS key provided, service account token authentication disabled"</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> s.Etcd.StorageConfig.DeserializationCacheSize == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// When size of cache is not explicitly set, estimate its size based on</span></span><br><span class="line">		<span class="comment">// target memory usage.</span></span><br><span class="line">		glog.V(<span class="number">2</span>).Infof(<span class="string">"Initializing deserialization cache size based on %dMB limit"</span>, s.GenericServerRunOptions.TargetRAMMB)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// This is the heuristics that from memory capacity is trying to infer</span></span><br><span class="line">		<span class="comment">// the maximum number of nodes in the cluster and set cache sizes based</span></span><br><span class="line">		<span class="comment">// on that value.</span></span><br><span class="line">		<span class="comment">// From our documentation, we officially recommend 120GB machines for</span></span><br><span class="line">		<span class="comment">// 2000 nodes, and we scale from that point. Thus we assume ~60MB of</span></span><br><span class="line">		<span class="comment">// capacity per node.</span></span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> We may consider deciding that some percentage of memory will</span></span><br><span class="line">		<span class="comment">// be used for the deserialization cache and divide it by the max object</span></span><br><span class="line">		<span class="comment">// size to compute its size. We may even go further and measure</span></span><br><span class="line">		<span class="comment">// collective sizes of the objects in the cache.</span></span><br><span class="line">		clusterSize := s.GenericServerRunOptions.TargetRAMMB / <span class="number">60</span></span><br><span class="line">		s.Etcd.StorageConfig.DeserializationCacheSize = <span class="number">25</span> * clusterSize</span><br><span class="line">		<span class="keyword">if</span> s.Etcd.StorageConfig.DeserializationCacheSize &lt; <span class="number">1000</span> &#123;</span><br><span class="line">			s.Etcd.StorageConfig.DeserializationCacheSize = <span class="number">1000</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> s.Etcd.EnableWatchCache &#123;</span><br><span class="line">		glog.V(<span class="number">2</span>).Infof(<span class="string">"Initializing cache sizes based on %dMB limit"</span>, s.GenericServerRunOptions.TargetRAMMB)</span><br><span class="line">		sizes := cachesize.NewHeuristicWatchCacheSizes(s.GenericServerRunOptions.TargetRAMMB)</span><br><span class="line">		<span class="keyword">if</span> userSpecified, err := serveroptions.ParseWatchCacheSizes(s.Etcd.WatchCacheSizes); err == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">for</span> resource, size := <span class="keyword">range</span> userSpecified &#123;</span><br><span class="line">				sizes[resource] = size</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		s.Etcd.WatchCacheSizes, err = serveroptions.WriteWatchCacheSizes(sizes)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> options, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> remove when we stop supporting the legacy group version.</span></span><br><span class="line">	<span class="keyword">if</span> s.APIEnablement.RuntimeConfig != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> key, value := <span class="keyword">range</span> s.APIEnablement.RuntimeConfig &#123;</span><br><span class="line">			<span class="keyword">if</span> key == <span class="string">"v1"</span> || strings.HasPrefix(key, <span class="string">"v1/"</span>) ||</span><br><span class="line">				key == <span class="string">"api/v1"</span> || strings.HasPrefix(key, <span class="string">"api/v1/"</span>) &#123;</span><br><span class="line">				<span class="built_in">delete</span>(s.APIEnablement.RuntimeConfig, key)</span><br><span class="line">				s.APIEnablement.RuntimeConfig[<span class="string">"/v1"</span>] = value</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> key == <span class="string">"api/legacy"</span> &#123;</span><br><span class="line">				<span class="built_in">delete</span>(s.APIEnablement.RuntimeConfig, key)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	options.ServerRunOptions = s</span><br><span class="line">	<span class="keyword">return</span> options, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-addflagset">3. AddFlagSet</h1>
<p><code>AddFlagSet</code>主要的作用是通过外部传入的flag的具体值，解析的时候传递给option的结构体，最终给apiserver使用。</p>
<p>其中<code>NewAPIServerCommand</code>关于<code>AddFlagSet</code>的相关代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fs := cmd.Flags()</span><br><span class="line">namedFlagSets := s.Flags()</span><br><span class="line"><span class="keyword">for</span> _, f := <span class="keyword">range</span> namedFlagSets.FlagSets &#123;</span><br><span class="line">	fs.AddFlagSet(f)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="31-flags">3.1. Flags</h2>
<p><code>Flags</code>完整代码如下：</p>
<blockquote>
<p>此部分代码位于cmd/kube-apiserver/app/options/options.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Flags returns flags for a specific APIServer by section name</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ServerRunOptions)</span> <span class="title">Flags</span><span class="params">()</span> <span class="params">(fss apiserverflag.NamedFlagSets)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Add the generic flags.</span></span><br><span class="line">	s.GenericServerRunOptions.AddUniversalFlags(fss.FlagSet(<span class="string">"generic"</span>))</span><br><span class="line">	s.Etcd.AddFlags(fss.FlagSet(<span class="string">"etcd"</span>))</span><br><span class="line">	s.SecureServing.AddFlags(fss.FlagSet(<span class="string">"secure serving"</span>))</span><br><span class="line">	s.InsecureServing.AddFlags(fss.FlagSet(<span class="string">"insecure serving"</span>))</span><br><span class="line">	s.InsecureServing.AddUnqualifiedFlags(fss.FlagSet(<span class="string">"insecure serving"</span>)) <span class="comment">// <span class="doctag">TODO:</span> remove it until kops stops using `--address`</span></span><br><span class="line">	s.Audit.AddFlags(fss.FlagSet(<span class="string">"auditing"</span>))</span><br><span class="line">	s.Features.AddFlags(fss.FlagSet(<span class="string">"features"</span>))</span><br><span class="line">	s.Authentication.AddFlags(fss.FlagSet(<span class="string">"authentication"</span>))</span><br><span class="line">	s.Authorization.AddFlags(fss.FlagSet(<span class="string">"authorization"</span>))</span><br><span class="line">	s.CloudProvider.AddFlags(fss.FlagSet(<span class="string">"cloud provider"</span>))</span><br><span class="line">	s.StorageSerialization.AddFlags(fss.FlagSet(<span class="string">"storage"</span>))</span><br><span class="line">	s.APIEnablement.AddFlags(fss.FlagSet(<span class="string">"api enablement"</span>))</span><br><span class="line">	s.Admission.AddFlags(fss.FlagSet(<span class="string">"admission"</span>))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Note: the weird ""+ in below lines seems to be the only way to get gofmt to</span></span><br><span class="line">	<span class="comment">// arrange these text blocks sensibly. Grrr.</span></span><br><span class="line">	fs := fss.FlagSet(<span class="string">"misc"</span>)</span><br><span class="line">	fs.DurationVar(&amp;s.EventTTL, <span class="string">"event-ttl"</span>, s.EventTTL,</span><br><span class="line">		<span class="string">"Amount of time to retain events."</span>)</span><br><span class="line"></span><br><span class="line">	fs.BoolVar(&amp;s.AllowPrivileged, <span class="string">"allow-privileged"</span>, s.AllowPrivileged,</span><br><span class="line">		<span class="string">"If true, allow privileged containers. [default=false]"</span>)</span><br><span class="line"></span><br><span class="line">	fs.BoolVar(&amp;s.EnableLogsHandler, <span class="string">"enable-logs-handler"</span>, s.EnableLogsHandler,</span><br><span class="line">		<span class="string">"If true, install a /logs handler for the apiserver logs."</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Deprecated in release 1.9</span></span><br><span class="line">	fs.StringVar(&amp;s.SSHUser, <span class="string">"ssh-user"</span>, s.SSHUser,</span><br><span class="line">		<span class="string">"If non-empty, use secure SSH proxy to the nodes, using this user name"</span>)</span><br><span class="line">	fs.MarkDeprecated(<span class="string">"ssh-user"</span>, <span class="string">"This flag will be removed in a future version."</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Deprecated in release 1.9</span></span><br><span class="line">	fs.StringVar(&amp;s.SSHKeyfile, <span class="string">"ssh-keyfile"</span>, s.SSHKeyfile,</span><br><span class="line">		<span class="string">"If non-empty, use secure SSH proxy to the nodes, using this user keyfile"</span>)</span><br><span class="line">	fs.MarkDeprecated(<span class="string">"ssh-keyfile"</span>, <span class="string">"This flag will be removed in a future version."</span>)</span><br><span class="line"></span><br><span class="line">	fs.Int64Var(&amp;s.MaxConnectionBytesPerSec, <span class="string">"max-connection-bytes-per-sec"</span>, s.MaxConnectionBytesPerSec, <span class="string">""</span>+</span><br><span class="line">		<span class="string">"If non-zero, throttle each user connection to this number of bytes/sec. "</span>+</span><br><span class="line">		<span class="string">"Currently only applies to long-running requests."</span>)</span><br><span class="line"></span><br><span class="line">	fs.IntVar(&amp;s.MasterCount, <span class="string">"apiserver-count"</span>, s.MasterCount,</span><br><span class="line">		<span class="string">"The number of apiservers running in the cluster, must be a positive number. (In use when --endpoint-reconciler-type=master-count is enabled.)"</span>)</span><br><span class="line"></span><br><span class="line">	fs.StringVar(&amp;s.EndpointReconcilerType, <span class="string">"endpoint-reconciler-type"</span>, <span class="keyword">string</span>(s.EndpointReconcilerType),</span><br><span class="line">		<span class="string">"Use an endpoint reconciler ("</span>+strings.Join(reconcilers.AllTypes.Names(), <span class="string">", "</span>)+<span class="string">")"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// See #14282 for details on how to test/try this option out.</span></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> remove this comment once this option is tested in CI.</span></span><br><span class="line">	fs.IntVar(&amp;s.KubernetesServiceNodePort, <span class="string">"kubernetes-service-node-port"</span>, s.KubernetesServiceNodePort, <span class="string">""</span>+</span><br><span class="line">		<span class="string">"If non-zero, the Kubernetes master service (which apiserver creates/maintains) will be "</span>+</span><br><span class="line">		<span class="string">"of type NodePort, using this as the value of the port. If zero, the Kubernetes master "</span>+</span><br><span class="line">		<span class="string">"service will be of type ClusterIP."</span>)</span><br><span class="line"></span><br><span class="line">	fs.IPNetVar(&amp;s.ServiceClusterIPRange, <span class="string">"service-cluster-ip-range"</span>, s.ServiceClusterIPRange, <span class="string">""</span>+</span><br><span class="line">		<span class="string">"A CIDR notation IP range from which to assign service cluster IPs. This must not "</span>+</span><br><span class="line">		<span class="string">"overlap with any IP ranges assigned to nodes for pods."</span>)</span><br><span class="line"></span><br><span class="line">	fs.Var(&amp;s.ServiceNodePortRange, <span class="string">"service-node-port-range"</span>, <span class="string">""</span>+</span><br><span class="line">		<span class="string">"A port range to reserve for services with NodePort visibility. "</span>+</span><br><span class="line">		<span class="string">"Example: '30000-32767'. Inclusive at both ends of the range."</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Kubelet related flags:</span></span><br><span class="line">	fs.BoolVar(&amp;s.KubeletConfig.EnableHttps, <span class="string">"kubelet-https"</span>, s.KubeletConfig.EnableHttps,</span><br><span class="line">		<span class="string">"Use https for kubelet connections."</span>)</span><br><span class="line"></span><br><span class="line">	fs.StringSliceVar(&amp;s.KubeletConfig.PreferredAddressTypes, <span class="string">"kubelet-preferred-address-types"</span>, s.KubeletConfig.PreferredAddressTypes,</span><br><span class="line">		<span class="string">"List of the preferred NodeAddressTypes to use for kubelet connections."</span>)</span><br><span class="line"></span><br><span class="line">	fs.UintVar(&amp;s.KubeletConfig.Port, <span class="string">"kubelet-port"</span>, s.KubeletConfig.Port,</span><br><span class="line">		<span class="string">"DEPRECATED: kubelet port."</span>)</span><br><span class="line">	fs.MarkDeprecated(<span class="string">"kubelet-port"</span>, <span class="string">"kubelet-port is deprecated and will be removed."</span>)</span><br><span class="line"></span><br><span class="line">	fs.UintVar(&amp;s.KubeletConfig.ReadOnlyPort, <span class="string">"kubelet-read-only-port"</span>, s.KubeletConfig.ReadOnlyPort,</span><br><span class="line">		<span class="string">"DEPRECATED: kubelet port."</span>)</span><br><span class="line"></span><br><span class="line">	fs.DurationVar(&amp;s.KubeletConfig.HTTPTimeout, <span class="string">"kubelet-timeout"</span>, s.KubeletConfig.HTTPTimeout,</span><br><span class="line">		<span class="string">"Timeout for kubelet operations."</span>)</span><br><span class="line"></span><br><span class="line">	fs.StringVar(&amp;s.KubeletConfig.CertFile, <span class="string">"kubelet-client-certificate"</span>, s.KubeletConfig.CertFile,</span><br><span class="line">		<span class="string">"Path to a client cert file for TLS."</span>)</span><br><span class="line"></span><br><span class="line">	fs.StringVar(&amp;s.KubeletConfig.KeyFile, <span class="string">"kubelet-client-key"</span>, s.KubeletConfig.KeyFile,</span><br><span class="line">		<span class="string">"Path to a client key file for TLS."</span>)</span><br><span class="line"></span><br><span class="line">	fs.StringVar(&amp;s.KubeletConfig.CAFile, <span class="string">"kubelet-certificate-authority"</span>, s.KubeletConfig.CAFile,</span><br><span class="line">		<span class="string">"Path to a cert file for the certificate authority."</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> delete this flag in 1.13</span></span><br><span class="line">	repair := <span class="literal">false</span></span><br><span class="line">	fs.BoolVar(&amp;repair, <span class="string">"repair-malformed-updates"</span>, <span class="literal">false</span>, <span class="string">"deprecated"</span>)</span><br><span class="line">	fs.MarkDeprecated(<span class="string">"repair-malformed-updates"</span>, <span class="string">"This flag will be removed in a future version"</span>)</span><br><span class="line"></span><br><span class="line">	fs.StringVar(&amp;s.ProxyClientCertFile, <span class="string">"proxy-client-cert-file"</span>, s.ProxyClientCertFile, <span class="string">""</span>+</span><br><span class="line">		<span class="string">"Client certificate used to prove the identity of the aggregator or kube-apiserver "</span>+</span><br><span class="line">		<span class="string">"when it must call out during a request. This includes proxying requests to a user "</span>+</span><br><span class="line">		<span class="string">"api-server and calling out to webhook admission plugins. It is expected that this "</span>+</span><br><span class="line">		<span class="string">"cert includes a signature from the CA in the --requestheader-client-ca-file flag. "</span>+</span><br><span class="line">		<span class="string">"That CA is published in the 'extension-apiserver-authentication' configmap in "</span>+</span><br><span class="line">		<span class="string">"the kube-system namespace. Components receiving calls from kube-aggregator should "</span>+</span><br><span class="line">		<span class="string">"use that CA to perform their half of the mutual TLS verification."</span>)</span><br><span class="line">	fs.StringVar(&amp;s.ProxyClientKeyFile, <span class="string">"proxy-client-key-file"</span>, s.ProxyClientKeyFile, <span class="string">""</span>+</span><br><span class="line">		<span class="string">"Private key for the client certificate used to prove the identity of the aggregator or kube-apiserver "</span>+</span><br><span class="line">		<span class="string">"when it must call out during a request. This includes proxying requests to a user "</span>+</span><br><span class="line">		<span class="string">"api-server and calling out to webhook admission plugins."</span>)</span><br><span class="line"></span><br><span class="line">	fs.BoolVar(&amp;s.EnableAggregatorRouting, <span class="string">"enable-aggregator-routing"</span>, s.EnableAggregatorRouting,</span><br><span class="line">		<span class="string">"Turns on aggregator routing requests to endpoints IP rather than cluster IP."</span>)</span><br><span class="line"></span><br><span class="line">	fs.StringVar(&amp;s.ServiceAccountSigningKeyFile, <span class="string">"service-account-signing-key-file"</span>, s.ServiceAccountSigningKeyFile, <span class="string">""</span>+</span><br><span class="line">		<span class="string">"Path to the file that contains the current private key of the service account token issuer. The issuer will sign issued ID tokens with this private key. (Requires the 'TokenRequest' feature gate.)"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> fss</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-run">4. Run</h1>
<p><code>Run</code>以常驻的方式运行apiserver。</p>
<p><strong>主要内容如下：</strong></p>
<ol>
<li>构造一个聚合的server结构体。</li>
<li>执行PrepareRun。</li>
<li>最终执行Run。</li>
</ol>
<blockquote>
<p>此部分代码位于cmd/kube-apiserver/app/server.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run runs the specified APIServer.  This should never exit.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Run</span><span class="params">(completeOptions completedServerRunOptions, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// To help debugging, immediately log version</span></span><br><span class="line">	glog.Infof(<span class="string">"Version: %+v"</span>, version.Get())</span><br><span class="line"></span><br><span class="line">	server, err := CreateServerChain(completeOptions, stopCh)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> server.PrepareRun().Run(stopCh)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="41-createserverchain">4.1. CreateServerChain</h2>
<p>构造聚合的Server。</p>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>首先生成config对象，包括<code>kubeAPIServerConfig</code>、<code>apiExtensionsConfig</code>。</li>
<li>再通过config生成server对象，包括<code>apiExtensionsServer</code>、<code>kubeAPIServer</code>。</li>
<li>执行<code>apiExtensionsServer</code>、<code>kubeAPIServer</code>的<code>PrepareRun</code>部分。</li>
<li>生成聚合的config对象<code>aggregatorConfig</code>。</li>
<li>基于<code>aggregatorConfig</code>、<code>kubeAPIServer</code>、<code>apiExtensionsServer</code>生成聚合的server<code>aggregatorServer</code>。</li>
</ol>
<blockquote>
<p>此部分代码位于cmd/kube-apiserver/app/server.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CreateServerChain creates the apiservers connected via delegation.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateServerChain</span><span class="params">(completedOptions completedServerRunOptions, stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="params">(*genericapiserver.GenericAPIServer, error)</span></span> &#123;</span><br><span class="line">	nodeTunneler, proxyTransport, err := CreateNodeDialer(completedOptions)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	kubeAPIServerConfig, insecureServingInfo, serviceResolver, pluginInitializer, admissionPostStartHook, err := CreateKubeAPIServerConfig(completedOptions, nodeTunneler, proxyTransport)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If additional API servers are added, they should be gated.</span></span><br><span class="line">	apiExtensionsConfig, err := createAPIExtensionsConfig(*kubeAPIServerConfig.GenericConfig, kubeAPIServerConfig.ExtraConfig.VersionedInformers, pluginInitializer, completedOptions.ServerRunOptions, completedOptions.MasterCount)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	apiExtensionsServer, err := createAPIExtensionsServer(apiExtensionsConfig, genericapiserver.NewEmptyDelegate())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	kubeAPIServer, err := CreateKubeAPIServer(kubeAPIServerConfig, apiExtensionsServer.GenericAPIServer, admissionPostStartHook)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// otherwise go down the normal path of standing the aggregator up in front of the API server</span></span><br><span class="line">	<span class="comment">// this wires up openapi</span></span><br><span class="line">	kubeAPIServer.GenericAPIServer.PrepareRun()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// This will wire up openapi for extension api server</span></span><br><span class="line">	apiExtensionsServer.GenericAPIServer.PrepareRun()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// aggregator comes last in the chain</span></span><br><span class="line">	aggregatorConfig, err := createAggregatorConfig(*kubeAPIServerConfig.GenericConfig, completedOptions.ServerRunOptions, kubeAPIServerConfig.ExtraConfig.VersionedInformers, serviceResolver, proxyTransport, pluginInitializer)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	aggregatorServer, err := createAggregatorServer(aggregatorConfig, kubeAPIServer.GenericAPIServer, apiExtensionsServer.Informers)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// we don't need special handling for innerStopCh because the aggregator server doesn't create any go routines</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> insecureServingInfo != <span class="literal">nil</span> &#123;</span><br><span class="line">		insecureHandlerChain := kubeserver.BuildInsecureHandlerChain(aggregatorServer.GenericAPIServer.UnprotectedHandler(), kubeAPIServerConfig.GenericConfig)</span><br><span class="line">		<span class="keyword">if</span> err := insecureServingInfo.Serve(insecureHandlerChain, kubeAPIServerConfig.GenericConfig.RequestTimeout, stopCh); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> aggregatorServer.GenericAPIServer, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="42-preparerun">4.2. PrepareRun</h2>
<p><code>PrepareRun</code>主要执行一些API安装操作。</p>
<blockquote>
<p>此部分的代码位于vendor/k8s.io/apiserver/pkg/server/genericapiserver.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PrepareRun does post API installation setup steps.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *GenericAPIServer)</span> <span class="title">PrepareRun</span><span class="params">()</span> <span class="title">preparedGenericAPIServer</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> s.swaggerConfig != <span class="literal">nil</span> &#123;</span><br><span class="line">		routes.Swagger&#123;Config: s.swaggerConfig&#125;.Install(s.Handler.GoRestfulContainer)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> s.openAPIConfig != <span class="literal">nil</span> &#123;</span><br><span class="line">		routes.OpenAPI&#123;</span><br><span class="line">			Config: s.openAPIConfig,</span><br><span class="line">		&#125;.Install(s.Handler.GoRestfulContainer, s.Handler.NonGoRestfulMux)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	s.installHealthz()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register audit backend preShutdownHook.</span></span><br><span class="line">	<span class="keyword">if</span> s.AuditBackend != <span class="literal">nil</span> &#123;</span><br><span class="line">		s.AddPreShutdownHook(<span class="string">"audit-backend"</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">			s.AuditBackend.Shutdown()</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> preparedGenericAPIServer&#123;s&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="43-preparedgenericapiserverrun">4.3. preparedGenericAPIServer.Run</h2>
<p><code>preparedGenericAPIServer.Run</code>运行一个安全的http server。具体的实现逻辑待后续文章分析。</p>
<blockquote>
<p>此部分代码位于vendor/k8s.io/apiserver/pkg/server/genericapiserver.go</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run spawns the secure http server. It only returns if stopCh is closed</span></span><br><span class="line"><span class="comment">// or the secure port cannot be listened on initially.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s preparedGenericAPIServer)</span> <span class="title">Run</span><span class="params">(stopCh &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	err := s.NonBlockingRun(stopCh)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	&lt;-stopCh</span><br><span class="line"></span><br><span class="line">	err = s.RunPreShutdownHooks()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Wait for all requests to finish, which are bounded by the RequestTimeout variable.</span></span><br><span class="line">	s.HandlerChainWaitGroup.Wait()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">err := s.NonBlockingRun(stopCh)</span><br></pre></td></tr></table></figure>
<p><code>preparedGenericAPIServer.Run</code>主要是调用<code>NonBlockingRun</code>函数，最终运行一个http server。该部分逻辑待后续文章分析。</p>
<h1 id="5-总结">5. 总结</h1>
<p><code>NewAPIServerCommand</code>采用了<a href="https://github.com/spf13/cobra" target="_blank" rel="noopener">Cobra</a>命令行框架，该框架使用主要包含以下部分：</p>
<ul>
<li>构造option参数，提供给执行主体(例如 本文的server)作为配置参数使用。</li>
<li>添加Flags，主要用来通过传入的flags参数最终解析成option中使用的结构体属性。</li>
<li>执行Run函数，执行主体的运行逻辑部分（核心部分）。</li>
</ul>
<p>其中Run函数的主要内容如下：</p>
<ol>
<li>构造一个聚合的server结构体。</li>
<li>执行PrepareRun。</li>
<li>最终执行preparedGenericAPIServer.Run。</li>
</ol>
<p><code>preparedGenericAPIServer.Run</code>主要是调用<code>NonBlockingRun</code>函数，最终运行一个http server。<code>NonBlockingRun</code>的具体逻辑待后续文章再单独分析。</p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kube-apiserver" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kube-apiserver</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-apiserver/app/server.go" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-apiserver/app/server.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-apiserver/app/aggregator.go" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-apiserver/app/aggregator.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-apiserver/app/options/options.go" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-apiserver/app/options/options.go</a></li>
</ul>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/article/k8s-source-code-analysis/kubelet/NewMainKubelet/" data-toggle="tooltip" data-placement="top" title="kubelet源码分析（二）之 NewMainKubelet">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/article/k8s-source-code-analysis/kubelet/NewKubeletCommand/" data-toggle="tooltip" data-placement="top" title="kubelet源码分析（一）之 NewKubeletCommand">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <br>

                <!--打赏-->
                
                    <div class="reward">
                        <div class="reward-button">赏 <span class="reward-code"> 
                            <span class="alipay-code"> <img class="alipay-img" src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1551599640/blog/donate/alipay.jpg"><b>支付宝打赏</b></span> 
                            <span class="wechat-code"> <img class="wechat-img" src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1551599472/blog/donate/wechatpay.jpg"><b>微信打赏</b> </span>
                            </span></div>
                        <p class="reward-notice">赞赏一下</p>
                    </div>
                
                <!--打赏-->                

                <br>

                <!--分享-->
                
                    <div class="social-share"  data-wechat-qrcode-helper="" align="center"></div>
                    <!--  css & js -->
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
                
                <!--分享-->
                <br>                
                
                <!-- require APlayer -->
                
                    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
                    <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js"></script>
                    <script src="https://cdn.jsdelivr.net/npm/meting@1.2/dist/Meting.min.js"></script>
    
                    <div class="aplayer"
                        data-id="2423410161"
                        data-server="netease"
                        data-type="playlist"
                        data-fixed="true" >
                    </div>
                
                
                

                <br>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->

                
                    <!-- disqus 评论框 start -->
                    <div class="comment">
                        <div id="lv-container" data-id="city" data-uid="MTAyMC8zNDM0Mi8xMDg3OQ=="></div>
                    </div>
                    <!-- disqus 评论框 end -->
                

            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

  
    <style>
      span.toc-nav-number{
        display: none
      }
    </style>
  
    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#kube-apiserver源码分析一之-newapiservercommand"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">kube-apiserver源码分析（一）之 NewAPIServerCommand</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#1-main"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">1. Main</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#2-newapiservercommand"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">2. NewAPIServerCommand</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#3-newserverrunoptions"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">3. NewServerRunOptions</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#31-serverrunoptions"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">3.1. ServerRunOptions</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#32-newserverrunoptions"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">3.2. NewServerRunOptions</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#33-complete"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">3.3. Complete</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#3-addflagset"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">3. AddFlagSet</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#31-flags"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">3.1. Flags</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#4-run"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">4. Run</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#41-createserverchain"><span class="toc-nav-number">6.1.</span> <span class="toc-nav-text">4.1. CreateServerChain</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#42-preparerun"><span class="toc-nav-number">6.2.</span> <span class="toc-nav-text">4.2. PrepareRun</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#43-preparedgenericapiserverrun"><span class="toc-nav-number">6.3.</span> <span class="toc-nav-text">4.3. preparedGenericAPIServer.Run</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#5-总结"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">5. 总结</span></a></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#源码分析" title="源码分析">源码分析</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://blog.huweihuang.com" target="_blank">胡伟煌 | Blog</a></li>
                    
                        <li><a href="http://blog.csdn.net/huwh_" target="_blank">胡伟煌 | CSDN Blog</a></li>
                    
                        <li><a href="https://www.huweihuang.com/kubernetes-notes" target="_blank">Kubernetes 学习笔记</a></li>
                    
                        <li><a href="https://www.huweihuang.com/golang-notes" target="_blank">Golang 学习笔记</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






    <!-- 来必力City版公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
       (function(d, s) {
           var j, e = d.getElementsByTagName(s)[0];
    
           if (typeof LivereTower === 'function') { return; }
    
           j = d.createElement(s);
           j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
           j.async = true;
    
           e.parentNode.insertBefore(j, e);
       })(document, 'script');
    </script>
    <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
    <!-- 来必力City版 公共JS代码 end -->



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>


<!-- chrome Firefox 中文锚点定位失效-->
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
<!-- smooth scroll behavior polyfill  -->
<script type="text/javascript" src="/js/smoothscroll.js"></script>
<script>
        $('#toc').on('click','a',function(a){
            // var isChrome = window.navigator.userAgent.indexOf("Chrome") !== -1;
            // console.log(window.navigator.userAgent,isChrome)
                // if(isChrome) {
                    // console.log(a.currentTarget.outerHTML);
                    // console.log($(a.currentTarget).attr("href"));
                    //跳转到指定锚点
                    // document.getElementById(a.target.innerText.toLowerCase()).scrollIntoView(true);
                    document.getElementById($(a.currentTarget).attr("href").replace("#","")).scrollIntoView({behavior: 'smooth' });
                // }
        })  
</script>

<!-- https://www.google.com/adsense -->

<script data-ad-client="ca-pub-8205636531078391" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>    



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/huweihuang">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                

                

                
                    <li>
                        <a target="_blank" href="https://www.facebook.com/huweihuang0">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://github.com/huweihuang">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://www.linkedin.com/in/huweihuang">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 胡伟煌 2022 
                    <br>
                    Theme by <a href="http://beantech.org">BeanTech</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://www.huweihuang.com">胡伟煌</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huweihuang&repo=hexo-theme-huweihuang&type=star&count=true" >
                    </iframe>
                    <br>
                    闽ICP备18027922号 | 闽公网安备35020302033291号                    
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://www.huweihuang.com/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-114718458-2';
    var _gaDomain = 'www.huweihuang.com';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = 'e146d71b77957235bba1e709d930f62e';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<!-- <img src="http://www.huweihuang.com/img/icon_wechat.png" width="0" height="0" /> -->
<!-- Migrate from head to bottom, no longer block render and still work -->

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>

</html>
